<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="Css/style.css">
  <link rel="stylesheet" href="Css/cgu-style.css">
  <!-- Pr√©chargement des ressources critiques -->
  <link rel="preload" href="Js/orleans-poi.js" as="script">
  <link rel="preload" href="Js/script.js" as="script">
  <link rel="preload" href="2019.mp3" as="audio">
  <!-- D√©sactiver la d√©tection de num√©ro de t√©l√©phone pour √©viter les surlignages -->
  <meta name="format-detection" content="telephone=no">
  <!-- Ajouter le script des POI d'Orl√©ans avant le script principal -->
  <script src="Js/orleans-poi.js"></script>
  <script src="Js/script.js" defer></script>

  <title>Zones de ronds regroup√©s</title>
  <style>
    /* Style pour le rectangle de localisation, adapt√© au style existant avec moins de transparence */
    #user-location-box {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0, 255, 204, 0.2); /* Transparence r√©duite */
      padding: 12px;
      border-radius: 12px;
      font-size: 14px;
      color: #00ffcc;
      box-shadow: 0 2px 16px rgba(0, 255, 204, 0.3), 0 1px 8px rgba(0, 0, 0, 0.5); /* Ombre plus prononc√©e */
      z-index: 1000;
      width: 220px;
      max-width: 90vw;
      display: none;
      border: 2px solid rgba(0, 255, 204, 0.5); /* Bordure plus visible */
      backdrop-filter: blur(19px); /* Effet de flou plus intense */
      font-family: 'Fira Mono', 'Consolas', monospace;
      cursor: move; /* Indique que l'√©l√©ment est d√©pla√ßable */
      touch-action: none; /* Emp√™che l'action tactile par d√©faut */
      transition: all 0.3s ease-in-out; /* Transition pour les animations */
    }
    
    /* Nouvelle classe pour l'√©tat r√©duit */
    #user-location-box.minimized {
      width: 40px;
      height: 40px;
      padding: 8px;
      border-radius: 50%;
      overflow: hidden;
      opacity: 0.7;
      background: rgba(0, 255, 204, 0.3);
    }
    
    #user-location-box.minimized:hover {
      opacity: 1;
    }
    
    #user-location-box .location-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid rgba(0, 255, 204, 0.3);
      padding-bottom: 5px;
      justify-content: space-between; /* Pour mettre le bouton √† droite */
    }
    
    #user-location-box .location-icon {
      color: #00ffcc;
      margin-right: 8px;
      font-size: 16px;
    }
    
    #user-location-box .location-title {
      font-weight: bold;
      color: #00ffcc;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    
    /* Style pour le bouton de r√©duction */
    #user-location-box .location-minimize {
      background: none;
      border: none;
      color: rgba(0, 255, 204, 0.7);
      cursor: pointer;
      font-size: 16px;
      padding: 0;
      transition: color 0.3s;
      margin-left: auto;
    }
    
    #user-location-box .location-minimize:hover {
      color: #00ffcc;
    }
    
    /* Ic√¥ne √† afficher quand la bo√Æte est minimis√©e */
    #user-location-box .location-expand {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #00ffcc;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    #user-location-box.minimized .location-expand {
      opacity: 1;
    }
    
    #user-location-box.minimized .location-content {
      opacity: 0;
      pointer-events: none;
    }
    
    #user-location-box .location-content {
      opacity: 1;
      transition: opacity 0.3s;
    }
    
    #user-location-box .info-item {
      margin-bottom: 10px;
      font-size: 12px;
    }
    
    #user-location-box .info-label {
      font-weight: bold;
      color: rgba(255, 255, 255, 0.7);
      display: block;
      margin-bottom: 4px;
      font-size: 11px;
      letter-spacing: 0.5px;
    }
    
    #user-location-box .info-value {
      background-color: rgba(7, 17, 77, 0.8); /* Fond plus fonc√© et moins transparent */
      padding: 6px 8px;
      border-radius: 4px;
      font-family: 'Fira Mono', monospace;
      font-size: 11px;
      word-break: break-all;
      color: #fff;
      border: 1px solid rgba(0, 255, 204, 0.4); /* Bordure plus visible */
    }
    
    #user-location-box .location-refresh {
      background: rgba(0, 255, 204, 0.13);
      color: #00ffcc;
      border: 1px solid #00ffcc;
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      margin-top: 6px;
      display: inline-block;
      font-family: 'Fira Mono', 'Consolas', monospace;
      letter-spacing: 0.5px;
      transition: background 0.3s, color 0.3s;
    }
    
    #user-location-box .location-refresh:hover {
      background: #00ffcc;
      color: #111;
    }
    
    /* Adaptation pour mobile */
    @media (max-width: 600px) {
      #user-location-box {
        max-width: 80vw;
        width: 160px; /* Taille r√©duite sur mobile */
        font-size: 11px; /* Police plus petite sur mobile */
        padding: 8px; /* Padding r√©duit */
      }
      
      #user-location-box.minimized {
        width: 32px;
        height: 32px;
      }
      
      #user-location-box .location-title {
        font-size: 12px;
      }
      
      #user-location-box .info-label {
        font-size: 10px;
      }
      
      #user-location-box .info-value {
        font-size: 10px;
        padding: 4px 6px;
      }
      
      #user-location-box .location-refresh {
        padding: 4px 8px;
        font-size: 10px;
      }

      canvas {
        /* Utiliser le GPU pour le rendu */
        transform: translateZ(0);
        backface-visibility: hidden;
        perspective: 1000px;
        will-change: transform;
      }
      
      /* Simplifier les animations sur mobile */
      #circle-coord-display {
        transition: none; /* D√©sactiver les transitions sur mobile */
      }
      
      /* R√©duire la taille des √©l√©ments sur mobile pour de meilleures performances */
      #circle-coord-display {
        font-size: 10px;
        padding: 6px 8px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
      }
    }

    /* Styles pour l'affichage du POI */
    #circle-coord-display {
      position: fixed;
      background: rgba(0, 40, 30, 0.85);
      color: #00ffcc;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-family: 'Fira Mono', monospace;
      pointer-events: none;
      z-index: 1000;
      display: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 255, 204, 0.5);
      max-width: 250px;
    }
    
    #circle-coord-display .coord-label {
      color: rgba(0, 255, 204, 0.7);
      margin-right: 5px;
      font-weight: bold;
    }
    
    #circle-coord-display .poi-name-container {
      margin-bottom: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid rgba(0, 255, 204, 0.3);
      font-weight: bold;
      text-align: center;
      font-size: 14px;
      display: block; /* Toujours visible */
    }
    
    #hover-poi-name {
      color: white;
      text-shadow: 0 0 8px rgba(0, 255, 204, 0.8);
    }

    /* Performance toggle button */
    #performance-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(0, 40, 30, 0.8);
      border: 1px solid rgba(0, 255, 204, 0.6);
      color: #00ffcc;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-family: 'Fira Mono', monospace;
      z-index: 1000;
      cursor: pointer;
      display: none; /* Hidden by default, shown on mobile */
    }
  </style>
</head>
<body>


<div id="mobile-info">
  Bonjour Raffineur num√©ro 587 ! D√©p√™chez-vous d'aller rafinner !
</div>

<!-- Ajout d'un encart pour afficher les coordonn√©es des cercles au survol avec une meilleure structure -->
<div id="circle-coord-display">
  <div class="poi-name-container">
    <span id="hover-poi-name">Lieu inconnu</span>
  </div>
  <div><span class="coord-label">Lat:</span><span id="hover-lat">0.0000</span></div>
  <div><span class="coord-label">Long:</span><span id="hover-long">0.0000</span></div>
</div>

<!-- Ajout du rectangle de g√©olocalisation modifi√© -->
<div id="user-location-box">
  <div class="location-expand">üìç</div>
  <div class="location-content">
    <div class="location-header">
      <span class="location-icon">üìç</span>
      <span class="location-title">Votre position</span>
      <button class="location-minimize">‚àí</button>
    </div>
    
    <div class="info-item">
      <div class="info-label">Coordonn√©es</div>
      <div id="user-coordinates" class="info-value">Chargement...</div>
    </div>
    
    <div class="info-item">
      <div class="info-label">Adresse</div>
      <div id="user-address" class="info-value">Chargement...</div>
    </div>
    
    <button class="location-refresh" onclick="getUserLocation()">Actualiser</button>
  </div>
</div>

<canvas id="canvas" style="display: block;"></canvas>
<audio id="sound" src="2019.mp3" preload="auto"></audio>
<audio id="backgroundMusic" src="SONORE/CHROMEA Theme.mp3" loop preload="auto" autoplay></audio>

<!-- Ajouter un bouton pour basculer le mode performance -->
<button id="performance-toggle">Mode performance: ON</button>

<script>
  // Essaye de jouer la musique d√®s que possible
  document.addEventListener('click', function() {
    document.getElementById('backgroundMusic').play().catch(() => {
      console.log("Impossible de lire automatiquement l'audio, attente d'une interaction utilisateur");
    });
  }, { once: true });

  // Essai de lecture au chargement (pourrait √™tre bloqu√© par le navigateur)
  window.addEventListener('load', function() {
    setTimeout(() => {
      document.getElementById('backgroundMusic').play().catch(() => {});
    }, 1000);
  });

  // Fonction pour obtenir la g√©olocalisation de l'utilisateur
  function getUserLocation() {
    const locationBox = document.getElementById('user-location-box');
    locationBox.style.display = 'block';
    
    // Si le panneau est minimis√©, le restaurer avant d'actualiser
    if (locationBox.classList.contains('minimized')) {
      toggleLocationBox();
    }
    
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 60000 // Utiliser une position en cache si disponible (max 1 minute)
      });
    } else {
      document.getElementById('user-coordinates').textContent = "G√©olocalisation non support√©e";
      document.getElementById('user-address').textContent = "Non disponible";
    }
  }
  
  function showPosition(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    
    // Afficher les coordonn√©es sans la pr√©cision
    document.getElementById('user-coordinates').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    
    // Faire un g√©ocodage inverse pour obtenir l'adresse
    reverseGeocode(lat, lng);
  }
  
  function showError(error) {
    let errorMessage = "";
    switch(error.code) {
      case error.PERMISSION_DENIED:
        errorMessage = "Acc√®s refus√©";
        break;
      case error.POSITION_UNAVAILABLE:
        errorMessage = "Position indisponible";
        break;
      case error.TIMEOUT:
        errorMessage = "D√©lai expir√©";
        break;
      case error.UNKNOWN_ERROR:
        errorMessage = "Erreur inconnue";
        break;
    }
    document.getElementById('user-coordinates').textContent = errorMessage;
    document.getElementById('user-address').textContent = "Non disponible";
  }
  
  function reverseGeocode(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`;
    
    fetch(url)
      .then(response => response.json())
      .then(data => {
        // Simplifier l'adresse en extrayant uniquement les parties pertinentes
        let simplifiedAddress = '';
        
        if (data.address) {
          const address = data.address;
          const addressParts = [];
          
          // Ajouter le nom de la rue et le num√©ro s'ils existent
          if (address.road) {
            let roadName = address.road;
            if (address.house_number) {
              roadName += ' ' + address.house_number;
            }
            addressParts.push(roadName);
          }
          
          // Ajouter le quartier s'il existe
          if (address.suburb) {
            addressParts.push(address.suburb);
          }
          
          // Ajouter la ville s'il existe
          if (address.city || address.town || address.village) {
            addressParts.push(address.city || address.town || address.village);
          }
          
          simplifiedAddress = addressParts.join(', ');
        }
        
        // Si nous n'avons pas pu construire une adresse simplifi√©e, utiliser un format court de display_name
        if (!simplifiedAddress && data.display_name) {
          // Supprimer le pays et le code postal de la fin de l'adresse
          simplifiedAddress = data.display_name.split(',').slice(0, 3).join(',');
        }
        
        // Utiliser une valeur par d√©faut si l'adresse est vide
        if (!simplifiedAddress) {
          simplifiedAddress = 'Adresse inconnue';
        }
        
        // Mettre √† jour l'interface utilisateur
        document.getElementById('user-address').textContent = simplifiedAddress;
      })
      .catch(error => {
        console.error("Erreur lors de la r√©cup√©ration de l'adresse:", error);
        document.getElementById('user-address').textContent = "Impossible de r√©cup√©rer l'adresse";
      });
  }
  
  // Remplacer la fonction hideLocationBox par toggleLocationBox
  function toggleLocationBox() {
    const locationBox = document.getElementById('user-location-box');
    locationBox.classList.toggle('minimized');
    
    // Sauvegarder l'√©tat dans le localStorage pour le restaurer au rechargement
    const isMinimized = locationBox.classList.contains('minimized');
    localStorage.setItem('locationBoxMinimized', isMinimized);
  }

  // Code pour rendre le rectangle de localisation d√©pla√ßable
  let isDragging = false;
  let offsetX, offsetY;
  const locationBox = document.getElementById('user-location-box');

  // Fonction pour d√©marrer le d√©placement
  function startDrag(e) {
    const isTouch = e.type.startsWith('touch');
    const clientX = isTouch ? e.touches[0].clientX : e.clientX;
    const clientY = isTouch ? e.touches[0].clientY : e.clientY;
    
    // Ne pas d√©clencher le drag si on clique sur les boutons
    if (e.target.classList.contains('location-minimize') || 
        e.target.classList.contains('location-refresh')) {
      return;
    }
    
    const rect = locationBox.getBoundingClientRect();
    offsetX = clientX - rect.left;
    offsetY = clientY - rect.top;
    isDragging = true;
    
    // Emp√™cher les comportements par d√©faut
    if (isTouch) {
      e.preventDefault();
    }
  }

  // Fonction pour le d√©placement en cours
  function drag(e) {
    if (!isDragging) return;
    
    const isTouch = e.type.startsWith('touch');
    const clientX = isTouch ? e.touches[0].clientX : e.clientX;
    const clientY = isTouch ? e.touches[0].clientY : e.clientY;
    
    // Calculer la nouvelle position
    const newLeft = clientX - offsetX;
    const newTop = clientY - offsetY;
    
    // Limiter la position √† l'int√©rieur de la fen√™tre
    const maxX = window.innerWidth - locationBox.offsetWidth;
    const maxY = window.innerHeight - locationBox.offsetHeight;
    
    locationBox.style.left = `${Math.max(0, Math.min(maxX, newLeft))}px`;
    locationBox.style.top = `${Math.max(0, Math.min(maxY, newTop))}px`;
    
    // Emp√™cher les comportements par d√©faut (comme le scroll)
    if (isTouch) {
      e.preventDefault();
    }
  }

  // Fonction pour terminer le d√©placement
  function endDrag() {
    isDragging = false;
  }

  // Ajouter les gestionnaires d'√©v√©nements pour souris et tactile
  locationBox.addEventListener('mousedown', startDrag);
  locationBox.addEventListener('touchstart', startDrag, { passive: false });
  
  document.addEventListener('mousemove', drag);
  document.addEventListener('touchmove', drag, { passive: false });
  
  document.addEventListener('mouseup', endDrag);
  document.addEventListener('touchend', endDrag);
  document.addEventListener('touchcancel', endDrag);

  // Ajouter des √©couteurs d'√©v√©nement pour le bouton de minimisation et maximisation
  document.addEventListener('DOMContentLoaded', function() {
    const minimizeBtn = document.querySelector('.location-minimize');
    const expandIcon = document.querySelector('.location-expand');
    
    if (minimizeBtn) {
      minimizeBtn.addEventListener('click', toggleLocationBox);
    }
    
    if (expandIcon) {
      expandIcon.addEventListener('click', toggleLocationBox);
    }
    
    // Restaurer l'√©tat minimis√© au chargement si c'√©tait le cas
    const wasMinimized = localStorage.getItem('locationBoxMinimized') === 'true';
    if (wasMinimized && locationBox) {
      locationBox.classList.add('minimized');
    }
  });

  // Script pour initialiser directement l'application sans passer par les CGU
  window.addEventListener("load", function() {
    // Ajouter les gestionnaires d'√©v√©nements directement
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
      canvas.addEventListener("touchstart", handleInteraction, { passive: false });
      canvas.addEventListener("touchmove", handleHover, { passive: false });
      canvas.addEventListener("touchend", handleHoverEnd);
      showMobileInfo();
    } else {
      canvas.addEventListener("click", handleInteraction);
      canvas.addEventListener("mousemove", handleHover);
      canvas.addEventListener("mouseout", handleHoverEnd);
    }
    
    window.addEventListener("resize", debounce(resizeCanvas, 250));
    resizeCanvas();
    chooseSpecialCircles();
    assignCircleNumbersAndCoords();
    requestAnimationFrame(optimizeRendering);
    document.getElementById('backgroundMusic').play().catch(() => {});
    
    // S'assurer que l'√©l√©ment pour les coordonn√©es au survol existe
    if (!document.getElementById('circle-coord-display')) {
      const coordDisplay = document.createElement('div');
      coordDisplay.id = 'circle-coord-display';
      coordDisplay.innerHTML = `
        <div><span class="coord-label">Lat:</span><span id="hover-lat">0.0000</span></div>
        <div><span class="coord-label">Long:</span><span id="hover-long">0.0000</span></div>
      `;
      document.body.appendChild(coordDisplay);
    }
    
    // S'assurer que les variables globales pour les √©l√©ments DOM sont d√©finies
    window.circleCoordDisplay = document.getElementById('circle-coord-display');
    window.hoverLatSpan = document.getElementById('hover-lat');
    window.hoverLongSpan = document.getElementById('hover-long');
    window.hoverPoiName = document.getElementById('hover-poi-name');
    
    // Obtenir la localisation apr√®s un court d√©lai
    setTimeout(getUserLocation, 1000);
    
    // Associer les POI d'Orl√©ans aux cercles
    if (window.orleansPOI) {
      associatePOIsToCircles();
    } else {
      console.error("Les POI d'Orl√©ans ne sont pas charg√©s correctement");
    }

    // Ajouter le toggle de performance sur mobile
    if (isMobile) {
      const perfToggle = document.getElementById('performance-toggle');
      perfToggle.style.display = 'block';
      
      perfToggle.addEventListener('click', function() {
        // Acc√©der √† la variable dans window pour communiquer avec le script principal
        window.isPerformanceMode = !window.isPerformanceMode;
        this.textContent = `Mode performance: ${window.isPerformanceMode ? 'ON' : 'OFF'}`;
        
        // Communiquer le changement au script principal
        if (typeof isPerformanceMode !== 'undefined') {
          isPerformanceMode = window.isPerformanceMode;
          
          // Reset des compteurs
          skipFramesCount = 0;
          
          // Ajuster le seuil de saut de frames
          skipFramesThreshold = isPerformanceMode ? 2 : 0;
        }
      });
    }
    
    // Optimisation pour le chargement des audios sur mobile
    if (isMobile) {
      // Pr√©charger les sons seulement apr√®s interaction utilisateur
      document.addEventListener('touchstart', function() {
        setTimeout(() => {
          const backgroundMusic = document.getElementById('backgroundMusic');
          const sound = document.getElementById('sound');
          
          // Charger mais ne pas jouer
          backgroundMusic.load();
          sound.load();
          
          // R√©duire le volume sur mobile pour √©conomiser la batterie
          backgroundMusic.volume = 0.6;
        }, 1000);
      }, { once: true });
    }
  });
</script>
</body>
</html>