<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chroméa - Défi Couleur</title>
    <style>
        :root {
            --primary-bg: #111;
            --primary-accent: #00ffcc;
            --secondary-accent: #4267B2;
            --tertiary-accent: #362777;
            --text-light: #ffffff;
            --text-dark: #111;
            --card-bg: rgba(24, 44, 76, 0.15);
            --gradient-1: linear-gradient(135deg, #00ffcc 0%, #00A993 100%);
            --gradient-2: linear-gradient(135deg, #4267B2 0%, #2A4899 100%);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.25);
            --border-radius: 12px;
        }
        
        @font-face {
            font-family: 'Mikodacs';
            src: url('Mikodacs.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Fira Mono', 'Consolas', monospace, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: var(--primary-bg);
            color: var(--text-light);
            background-image: url('data:image/svg+xml;utf8,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="45" cy="15" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="15" cy="45" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="45" cy="45" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><polyline points="45,0 45,15 15,15 15,45 45,45 45,60" fill="none" stroke="%23222" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/></svg>');
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 60px 20px 10px;
        }
        
        #app-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            min-width: 340px;
            max-width: 100vw;
            height: 50px;
            background: linear-gradient(180deg, #182c4c 0%, #111 100%) !important;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 2px 8px #0008;
        }
        
        #banner-content {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 15px;
        }
        
        h1 {
            font-family: 'Mikodacs', serif;
            font-size: 1.5rem;
            color: var(--primary-accent);
            font-weight: 700;
            letter-spacing: 0.04em;
            text-shadow: 
                0 0 8px rgba(0, 255, 204, 0.4),
                0 0 16px rgba(0, 255, 204, 0.2);
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto 15px;
            background: rgba(24, 44, 76, 0.13);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow-soft);
            border: 2px solid rgba(0, 255, 204, 0.13);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .mode-toggle {
            display: flex;
            border-radius: 30px;
            overflow: hidden;
            margin: 0 auto 15px;
            width: 280px;
            border: 2px solid var(--primary-accent);
            box-shadow: 0 2px 16px rgba(0, 255, 204, 0.2);
            position: relative;
            z-index: 10;
        }
        
        .mode-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: rgba(0, 0, 0, 0.2);
            color: var(--primary-accent);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            font-family: 'Fira Mono', 'Consolas', monospace;
            letter-spacing: 1px;
        }
        
        .mode-btn.active {
            background: var(--primary-accent);
            color: var(--text-dark);
            box-shadow: 0 2px 10px rgba(0, 255, 204, 0.4);
        }
        
        .target-color-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .color-target {
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF0000, #00FF00);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
            border: 3px solid var(--text-light);
        }
        
        .target-instruction {
            font-size: 0.95rem;
            color: var(--primary-accent);
            text-align: center;
            margin-top: 8px;
        }
        
        #videoContainerChallenge {
            position: relative;
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            background-color: #131c50;
            aspect-ratio: 4/3;
            margin: 0 auto 10px;
            border: 2px solid rgba(0, 255, 204, 0.2);
        }
        
        #videoChallenge, #canvasChallenge {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: calc(var(--border-radius) - 2px);
        }
        
        #focus-grid-challenge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40%;
            height: 40%;
            border: 2px dashed rgba(0, 255, 204, 0.7);
            z-index: 2;
            pointer-events: none;
            border-radius: 8px;
            box-shadow: 0 0 12px rgba(0, 255, 204, 0.3);
        }
        
        #realtime-color-challenge {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(7, 17, 77, 0.8);
            backdrop-filter: blur(5px);
            color: white;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Fira Mono', 'Consolas', monospace;
            letter-spacing: 0.5px;
            border-top: 1px solid rgba(0, 255, 204, 0.2);
            z-index: 5;
        }
        
        #color-preview-challenge {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-result {
            background: rgba(24, 44, 76, 0.3);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            box-shadow: var(--shadow-soft);
            border: 2px solid rgba(0, 255, 204, 0.2);
            text-align: center;
        }
        
        .color-comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }
        
        .color-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .color-sample {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--text-light);
        }
        
        .score-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary-accent);
            margin-bottom: -10px;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
            font-family: 'Mikodacs', serif;
        }
        
        .feedback-message {
            color: var(--primary-accent);
            font-size: 1.1rem;
            margin-top: 15px;
            padding: 10px;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .container {
                padding: 10px;
                margin: 0 5px 10px;
                max-height: calc(100vh - 100px);
            }
            
            .color-target {
                width: 100px;
                height: 100px;
            }
            
            .color-sample {
                width: 50px;
                height: 50px;
            }
            
            .score-value {
                font-size: 2.2rem;
            }
            
            .feedback-message {
                font-size: 0.85rem;
                margin-top: 10px;
                padding: 5px;
            }
            
            #videoContainerChallenge {
                max-height: 35vh;
            }
            
            @media (max-height: 700px) {
                .color-target {
                    width: 80px;
                    height: 80px;
                }
                
                h2 {
                    font-size: 1.2rem;
                    margin-bottom: 10px;
                }
                
                .button-group {
                    margin-top: 8px;
                }
                
                #videoContainerChallenge {
                    max-height: 30vh;
                }
                
                .status-message {
                    padding: 5px 10px;
                    font-size: 0.8rem;
                }
            }
        }
    </style>
</head>
<body>
    <div id="app-banner">
        <div id="banner-content">
            <h1>Défi Couleur Chroméa</h1>
        </div>
    </div>
    
    <div class="mode-toggle">
        <button class="mode-btn active" id="challengeMode">Défi Couleur</button>
        <button class="mode-btn" id="galleryMode">Galerie Photos</button>
    </div>

    <div class="container" id="challengeModeContainer">
        <div class="target-color-container">
            <div id="targetColor" class="color-target"></div>
            <p class="target-instruction">Trouvez et photographiez une couleur similaire à celle-ci</p>
        </div>
        
        <div id="videoContainerChallenge">
            <video id="videoChallenge" autoplay playsinline></video>
            <canvas id="canvasChallenge" class="hidden"></canvas>
            <div id="videoPlaceholderChallenge">En attente d'activation de la caméra...</div>
            <div id="focus-grid-challenge"></div>
            <div id="realtime-color-challenge" class="hidden">
                <div id="color-preview-challenge"></div>
                <span id="color-value-challenge">#000000</span>
            </div>
        </div>
        
        <div class="button-group">
            <button id="switchCameraChallenge" class="primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a6 6 0 0 1 6-6h4.5L10 4.5l.7.7L14.2 2l-3.5-3.2-.7.7L12.5 2H8z"/>
                </svg>
                Changer de caméra
            </button>
            <button id="captureChallengeBtn" class="secondary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                    <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                </svg>
                Capturer cette couleur
            </button>
            <button id="newChallengeBtn" class="primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a6 6 0 0 1 6-6h4.5L10 4.5l.7.7L14.2 2l-3.5-3.2-.7.7L12.5 2H8z"/>
                </svg>
                Nouvelle couleur
            </button>
        </div>
        
        <div id="challengeResult" class="challenge-result hidden">
            <h3>Résultat</h3>
            <div class="color-comparison">
                <div class="color-box">
                    <div id="targetColorResult" class="color-sample"></div>
                    <p>Couleur cible</p>
                </div>
                <div class="score-display">
                    <div id="scoreValue" class="score-value">0</div>
                    <p>/ 10</p>
                </div>
                <div class="color-box">
                    <div id="capturedColorResult" class="color-sample"></div>
                    <p>Votre couleur</p>
                </div>
            </div>
            <div class="feedback-message" id="feedbackMessage">
                Essayez encore pour mieux correspondre à la couleur cible.
            </div>
        </div>
        
        <p id="challengeStatus" class="status-message">Initialisation du défi...</p>
    </div>

    <div class="container hidden" id="galleryModeContainer">
        <h2>Images Capturées</h2>
        <div class="gallery" id="photoGallery"></div>
        <div class="button-group">
            <button id="clearAllBtn" class="danger">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
                Supprimer toutes les images
            </button>
        </div>
    </div>

    <script>
        let facingMode = 'user';
        let photos = JSON.parse(localStorage.getItem('capturedPhotos')) || [];
        let streamChallenge;
        let challengeColorAnalysisInterval;
        
        const gradientMap = {
            "#00A993": "#E68B4A", "#E68B4A": "#7A1619", "#7A1619": "#362777",
            "#362777": "#EB7AAE", "#EB7AAE": "#0069AA", "#0069AA": "#DC0C15",
            "#DC0C15": "#E03A8D", "#E03A8D": "#FFFFFF", "#FFFFFF": "#2A4899",
            "#2A4899": "#00A993"
        };
        
        const challengeMode = document.getElementById('challengeMode');
        const galleryMode = document.getElementById('galleryMode');
        const challengeModeContainer = document.getElementById('challengeModeContainer');
        const galleryModeContainer = document.getElementById('galleryModeContainer');
        const videoChallenge = document.getElementById('videoChallenge');
        const canvasChallenge = document.getElementById('canvasChallenge');
        const ctxChallenge = canvasChallenge.getContext('2d');
        const targetColor = document.getElementById('targetColor');
        const captureChallengeBtn = document.getElementById('captureChallengeBtn');
        const newChallengeBtn = document.getElementById('newChallengeBtn');
        const switchCameraChallenge = document.getElementById('switchCameraChallenge');
        const challengeResult = document.getElementById('challengeResult');
        const targetColorResult = document.getElementById('targetColorResult');
        const capturedColorResult = document.getElementById('capturedColorResult');
        const scoreValue = document.getElementById('scoreValue');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const challengeStatus = document.getElementById('challengeStatus');
        const videoPlaceholderChallenge = document.getElementById('videoPlaceholderChallenge');
        const photoGallery = document.getElementById('photoGallery');
        
        let currentTargetColor = { r: 0, g: 0, b: 0 };
        
        challengeMode.addEventListener('click', () => {
            challengeMode.classList.add('active');
            galleryMode.classList.remove('active');
            challengeModeContainer.classList.remove('hidden');
            galleryModeContainer.classList.add('hidden');
            
            if (!streamChallenge) {
                initChallengeCamera();
                generateTargetColor();
            }
        });

        galleryMode.addEventListener('click', () => {
            galleryMode.classList.add('active');
            challengeMode.classList.remove('active');
            challengeModeContainer.classList.add('hidden');
            galleryModeContainer.classList.remove('hidden');
            
            stopChallengeColorAnalysis();
            
            loadGallery();
        });
        
        switchCameraChallenge.addEventListener('click', () => {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            initChallengeCamera();
        });

        async function initChallengeCamera() {
            try {
                if (streamChallenge) {
                    streamChallenge.getTracks().forEach(track => track.stop());
                    stopChallengeColorAnalysis();
                }
                
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                let constraints;
                
                if (isMobile) {
                    constraints = {
                        audio: false,
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                } else {
                    constraints = {
                        audio: false,
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                }
                
                streamChallenge = await navigator.mediaDevices.getUserMedia(constraints);
                videoChallenge.srcObject = streamChallenge;
                
                videoPlaceholderChallenge.style.display = 'none';
                videoChallenge.style.display = 'block';
                
                videoChallenge.onloadedmetadata = () => {
                    videoChallenge.play().catch(e => console.error('Erreur lors du démarrage de la vidéo challenge:', e));
                    
                    canvasChallenge.width = videoChallenge.videoWidth;
                    canvasChallenge.height = videoChallenge.videoHeight;
                    challengeStatus.textContent = 'Caméra prête. Trouvez une couleur similaire à la cible.';
                    
                    setTimeout(() => {
                        startChallengeColorAnalysis();
                    }, 500);
                };
                
                videoChallenge.onplaying = () => {
                    challengeStatus.textContent = 'Défi actif. Trouvez une couleur similaire à la cible.';
                };
            } catch (error) {
                challengeStatus.textContent = `Erreur d'accès à la caméra: ${error.message}`;
                console.error('Erreur d\'accès à la caméra du défi:', error);
                videoPlaceholderChallenge.style.display = 'flex';
                videoPlaceholderChallenge.textContent = `Erreur d'accès à la caméra: ${error.message}`;
            }
        }
        
        function extractDominantColor(imageData, focusOnCenter = false) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const colorCounts = {};
            
            const centerStartX = Math.floor(width * 0.3);
            const centerEndX = Math.floor(width * 0.7);
            const centerStartY = Math.floor(height * 0.3);
            const centerEndY = Math.floor(height * 0.7);
            
            const step = 5;
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (focusOnCenter && (
                        x < centerStartX || x > centerEndX || 
                        y < centerStartY || y > centerEndY
                    )) {
                        continue;
                    }
                    
                    const i = (y * width + x) * 4;
                    
                    if (data[i + 3] < 128 || (data[i] < 30 && data[i + 1] < 30 && data[i + 2] < 30)) {
                        continue;
                    }
                    
                    const r = Math.floor(data[i] / 10) * 10;
                    const g = Math.floor(data[i + 1] / 10) * 10;
                    const b = Math.floor(data[i + 2] / 10) * 10;
                    
                    const colorKey = `${r},${g},${b}`;
                    
                    if (!colorCounts[colorKey]) {
                        colorCounts[colorKey] = 0;
                    }
                    
                    const saturation = Math.max(r, g, b) - Math.min(r, g, b);
                    const weight = 1 + saturation / 255;
                    
                    colorCounts[colorKey] += weight;
                }
            }
            
            let maxCount = 0;
            let dominantColor = '0,0,0';
            
            for (const colorKey in colorCounts) {
                if (colorCounts[colorKey] > maxCount) {
                    maxCount = colorCounts[colorKey];
                    dominantColor = colorKey;
                }
            }
            
            const [r, g, b] = dominantColor.split(',').map(Number);
            return {
                rgb: `rgb(${r}, ${g}, ${b})`,
                hex: `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`
            };
        }
        
        function generateTargetColor() {
            const r = Math.floor(Math.random() * 200) + 25;
            const g = Math.floor(Math.random() * 200) + 25;
            const b = Math.floor(Math.random() * 200) + 25;
            
            currentTargetColor = { r, g, b };
            
            const hex = rgbToHex(r, g, b);
            
            targetColor.style.background = `rgb(${r}, ${g}, ${b})`;
            
            challengeResult.classList.add('hidden');
            
            challengeStatus.textContent = 'Nouvelle couleur générée. Trouvez une couleur similaire dans votre environnement.';
        }
        
        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }
        
        function startChallengeColorAnalysis() {
            if (challengeColorAnalysisInterval) {
                clearInterval(challengeColorAnalysisInterval);
            }
            
            const realtimeColorChallenge = document.getElementById('realtime-color-challenge');
            const colorPreviewChallenge = document.getElementById('color-preview-challenge');
            const colorValueChallenge = document.getElementById('color-value-challenge');
            
            realtimeColorChallenge.classList.remove('hidden');
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const interval = isMobile ? 300 : 200;
            
            challengeColorAnalysisInterval = setInterval(() => {
                if (!streamChallenge || videoChallenge.paused || videoChallenge.ended || !videoChallenge.videoWidth) {
                    return;
                }
                
                try {
                    if (tempCanvas.width !== videoChallenge.videoWidth || tempCanvas.height !== videoChallenge.videoHeight) {
                        tempCanvas.width = videoChallenge.videoWidth;
                        tempCanvas.height = videoChallenge.videoHeight;
                    }
                    
                    tempCtx.drawImage(videoChallenge, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const dominantColor = extractDominantColor(imageData, true);
                    
                    colorPreviewChallenge.style.backgroundColor = dominantColor.rgb;
                    colorValueChallenge.textContent = dominantColor.hex;
                } catch (e) {
                    console.error('Erreur dans l\'analyse de couleur du défi:', e);
                }
            }, interval);
        }
        
        function stopChallengeColorAnalysis() {
            if (challengeColorAnalysisInterval) {
                clearInterval(challengeColorAnalysisInterval);
                challengeColorAnalysisInterval = null;
            }
        }
        
        captureChallengeBtn.addEventListener('click', () => {
            ctxChallenge.drawImage(videoChallenge, 0, 0, canvasChallenge.width, canvasChallenge.height);
            
            const imageData = ctxChallenge.getImageData(0, 0, canvasChallenge.width, canvasChallenge.height);
            const dominantColor = extractDominantColor(imageData, true);
            
            evaluateColorMatch(dominantColor);
            
            const photoDataUrl = canvasChallenge.toDataURL('image/jpeg');
            savePhoto(photoDataUrl, dominantColor);
        });
        
        function evaluateColorMatch(capturedColor) {
            const rgbMatch = capturedColor.rgb.match(/rgb\((\d+), (\d+), (\d+)\)/);
            if (!rgbMatch) return;
            
            const capturedR = parseInt(rgbMatch[1]);
            const capturedG = parseInt(rgbMatch[2]);
            const capturedB = parseInt(rgbMatch[3]);
            
            const distance = Math.sqrt(
                Math.pow(currentTargetColor.r - capturedR, 2) +
                Math.pow(currentTargetColor.g - capturedG, 2) +
                Math.pow(currentTargetColor.b - capturedB, 2)
            );
            
            let score = 10 - (distance / 441.67) * 10;
            
            score = Math.max(0, Math.min(10, score));
            score = Math.round(score * 10) / 10;
            
            if (score > 9.5) score = 10;
            
            displayChallengeResults(capturedColor, score);
        }
        
        function displayChallengeResults(capturedColor, score) {
            targetColorResult.style.backgroundColor = `rgb(${currentTargetColor.r}, ${currentTargetColor.g}, ${currentTargetColor.b})`;
            capturedColorResult.style.backgroundColor = capturedColor.rgb;
            
            scoreValue.textContent = score.toString();
            
            let feedback;
            if (score >= 9) {
                feedback = "Parfait ! Vous avez un œil exceptionnel pour les couleurs !";
            } else if (score >= 7) {
                feedback = "Excellent ! Vous avez trouvé une couleur très proche.";
            } else if (score >= 5) {
                feedback = "Bien ! Vous avez un bon sens des couleurs.";
            } else if (score >= 3) {
                feedback = "Pas mal, mais essayez de trouver une couleur plus proche.";
            } else {
                feedback = "Essayez encore ! Cherchez une couleur qui ressemble plus à la cible.";
            }
            
            feedbackMessage.textContent = feedback;
            
            challengeResult.classList.remove('hidden');
            
            challengeStatus.textContent = "Couleur capturée et évaluée. Essayez à nouveau ou générez une nouvelle couleur.";
        }
        
        function savePhoto(dataUrl, dominantColor) {
            const timestamp = new Date().toISOString();
            photos.push({
                id: Date.now().toString(),
                url: dataUrl,
                timestamp: timestamp,
                dominantColor: dominantColor,
                targetColor: `rgb(${currentTargetColor.r}, ${currentTargetColor.g}, ${currentTargetColor.b})`
            });
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
        }
        
        function loadGallery() {
            photoGallery.innerHTML = '';
            
            if (photos.length === 0) {
                photoGallery.innerHTML = '<p>Aucune photo dans la galerie. Prenez des photos pour les voir ici.</p>';
                return;
            }
            
            photos.forEach((photo, index) => {
                const photoElement = document.createElement('div');
                photoElement.className = 'gallery-item';
                
                const dominantColor = photo.dominantColor || { rgb: 'rgb(128, 128, 128)', hex: '#808080' };
                const targetColorDisplay = photo.targetColor ? 
                    `<div class="color-swatch" style="background-color: ${photo.targetColor}"></div>` : '';
                
                photoElement.innerHTML = `
                    <img class="gallery-img" src="${photo.url}" alt="Photo ${index + 1}">
                    <button class="delete-btn" data-id="${photo.id}">✕</button>
                    <div class="color-info">
                        ${targetColorDisplay}
                        <div class="color-swatch" style="background-color: ${dominantColor.rgb}"></div>
                        <span>${dominantColor.hex}</span>
                    </div>
                `;
                photoGallery.appendChild(photoElement);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const photoId = e.target.dataset.id;
                    deletePhoto(photoId);
                });
            });
        }

        function deletePhoto(photoId) {
            photos = photos.filter(photo => photo.id !== photoId);
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
            loadGallery();
        }

        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('Êtes-vous sûr de vouloir supprimer toutes les photos?')) {
                photos = [];
                localStorage.setItem('capturedPhotos', JSON.stringify(photos));
                loadGallery();
            }
        });
        
        newChallengeBtn.addEventListener('click', generateTargetColor);
        
        function handleOrientationChange() {
            if (videoChallenge.videoWidth && videoChallenge.videoHeight) {
                canvasChallenge.width = videoChallenge.videoWidth;
                canvasChallenge.height = videoChallenge.videoHeight;
            }
            
            const galleryContainer = document.getElementById('galleryModeContainer');
            if (!galleryContainer.classList.contains('hidden')) {
                loadGallery();
            }
        }
        
        window.addEventListener('orientationchange', function() {
            setTimeout(handleOrientationChange, 300);
        });
        
        window.addEventListener('beforeunload', () => {
            stopChallengeColorAnalysis();
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                challengeStatus.textContent = 'Votre navigateur ne prend pas en charge l\'accès à la caméra.';
                videoPlaceholderChallenge.textContent = 'Votre navigateur ne prend pas en charge l\'accès à la caméra.';
            } else {
                initChallengeCamera();
                generateTargetColor();
            }
        });
    </script>
</body>
</html>