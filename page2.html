<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D√©tection d'acc√©l√©ration</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: sans-serif;
            font-size: 1.5rem;
            transition: background-color 0.5s;
            background-color: white;
            text-align: center;
            padding: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            margin-top: 20px;
            border-radius: 8px;
            background-color: #007aff;
            color: white;
            border: none;
            cursor: pointer;
        }
        #values {
            font-size: 1rem;
            margin-top: 20px;
        }
        #sensitivity {
            margin-top: 15px;
            width: 80%;
            max-width: 300px;
        }
        .control-panel {
            margin-top: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control-label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="message">Appuyez sur le bouton pour commencer</div>
    <button id="startButton">Activer l'acc√©l√©rom√®tre</button>
    
    <div class="control-panel" id="controls" style="display: none;">
        <div class="control-label">Sensibilit√©: <span id="sensitivityValue">5.0</span></div>
        <input type="range" id="sensitivity" min="1" max="10" step="0.5" value="5">
    </div>
    
    <div id="values"></div>

    <script>
        let lastSpeed = 0;
        let isRunning = false;
        let movementHistory = [];
        let stagnantTimer = null;
        let sensitivityValue = 5.0;
        
        const valuesElement = document.getElementById('values');
        const messageElement = document.getElementById('message');
        const startButton = document.getElementById('startButton');
        const controlsDiv = document.getElementById('controls');
        const sensitivitySlider = document.getElementById('sensitivity');
        const sensitivityDisplay = document.getElementById('sensitivityValue');
        
        // Met √† jour l'affichage de la sensibilit√©
        sensitivitySlider.addEventListener('input', function() {
            sensitivityValue = parseFloat(this.value);
            sensitivityDisplay.textContent = sensitivityValue.toFixed(1);
        });
        
        // Fonction qui d√©marre la d√©tection
        function startDetection() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ n√©cessite une permission explicite
                DeviceMotionEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            initAccelerometer();
                            messageElement.textContent = "Position stagnante";
                            startButton.style.display = 'none';
                            controlsDiv.style.display = 'flex';
                            document.body.style.backgroundColor = '#f0f0f0'; // couleur neutre pour stagnant
                        } else {
                            messageElement.textContent = "Permission refus√©e pour l'acc√©l√©rom√®tre";
                        }
                    })
                    .catch(error => {
                        messageElement.textContent = "Erreur: " + error.message;
                    });
            } else {
                // Pour les appareils qui n'ont pas besoin de permission
                initAccelerometer();
                messageElement.textContent = "Position stagnante";
                startButton.style.display = 'none';
                controlsDiv.style.display = 'flex';
                document.body.style.backgroundColor = '#f0f0f0';
            }
        }
        
        // Initialise l'acc√©l√©rom√®tre
        function initAccelerometer() {
            isRunning = true;
            
            // Premi√®re mesure de r√©f√©rence pour √©viter une d√©tection fausse au d√©marrage
            window.addEventListener('devicemotion', function initialMeasurement(event) {
                if (event.accelerationIncludingGravity) {
                    const acc = event.accelerationIncludingGravity;
                    lastSpeed = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
                    
                    // Maintenant qu'on a une mesure de r√©f√©rence, on peut d√©marrer la d√©tection continue
                    window.removeEventListener('devicemotion', initialMeasurement);
                    setTimeout(() => {
                        window.addEventListener('devicemotion', handleMotion);
                    }, 500); // Un petit d√©lai pour stabiliser
                }
            }, { once: true });
        }
        
        // G√®re les √©v√©nements de mouvement
        function handleMotion(event) {
            if (!isRunning) return;
            
            if (event.accelerationIncludingGravity) {
                const acc = event.accelerationIncludingGravity;
                
                // Afficher les valeurs brutes pour debug
                valuesElement.textContent = `x: ${acc.x.toFixed(2)}, y: ${acc.y.toFixed(2)}, z: ${acc.z.toFixed(2)}`;
                
                const speed = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
                const deltaSpeed = speed - lastSpeed;
                
                // Utilise la sensibilit√© du slider pour ajuster le seuil
                const threshold = 10 / sensitivityValue;
                
                // Garde un historique des mouvements r√©cents
                movementHistory.push(Math.abs(deltaSpeed));
                if (movementHistory.length > 5) {
                    movementHistory.shift();
                }
                
                // Calcule la moyenne de mouvement r√©cent
                const avgMovement = movementHistory.reduce((sum, val) => sum + val, 0) / movementHistory.length;
                
                // D√©tection des √©tats
                if (avgMovement < threshold / 3) {
                    // Si peu de mouvement, consid√©rer comme stagnant apr√®s un court d√©lai
                    if (stagnantTimer === null) {
                        stagnantTimer = setTimeout(() => {
                            document.body.style.backgroundColor = '#f0f0f0';
                            messageElement.textContent = 'Position stagnante';
                        }, 700);
                    }
                } else {
                    // Annuler le timer de stagnation s'il y a du mouvement
                    if (stagnantTimer !== null) {
                        clearTimeout(stagnantTimer);
                        stagnantTimer = null;
                    }
                    
                    if (deltaSpeed > threshold) {
                        // Acc√©l√©ration
                        document.body.style.backgroundColor = 'limegreen';
                        messageElement.textContent = 'Tu acc√©l√®res ! üöÄ';
                    } else if (deltaSpeed < -threshold) {
                        // Ralentissement
                        document.body.style.backgroundColor = 'tomato';
                        messageElement.textContent = 'Tu ralentis ! üõë';
                    }
                }
                
                lastSpeed = speed;
            }
        }
        
        // Attache l'√©v√©nement au bouton
        startButton.addEventListener('click', startDetection);
    </script>
</body>
</html>