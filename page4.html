<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chroméa - Défi Couleur</title>
    <style>
        :root {
            --primary-bg: #111;
            --primary-accent: #00ffcc;
            --secondary-accent: #4267B2;
            --tertiary-accent: #362777;
            --text-light: #ffffff;
            --text-dark: #111;
            --card-bg: rgba(24, 44, 76, 0.15);
            --gradient-1: linear-gradient(135deg, #00ffcc 0%, #00A993 100%);
            --gradient-2: linear-gradient(135deg, #4267B2 0%, #2A4899 100%);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.25);
            --border-radius: 12px;
        }
        
        @font-face {
            font-family: 'Mikodacs';
            src: url('Mikodacs.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Fira Mono', 'Consolas', monospace, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            background: var(--primary-bg);
            color: var(--text-light);
            background-image: url('data:image/svg+xml;utf8,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="15" cy="15" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="45" cy="15" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="15" cy="45" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><circle cx="45" cy="45" r="8" fill="none" stroke="%23222" stroke-width="1.2"/><polyline points="45,0 45,15 15,15 15,45 45,45 45,60" fill="none" stroke="%23222" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" opacity="0.7"/></svg>');
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 5px 10px;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            margin: 0 auto 10px;
            background: rgba(24, 44, 76, 0.13);
            backdrop-filter: blur(12px);
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow-soft);
            border: 2px solid rgba(0, 255, 204, 0.13);
            max-height: calc(100vh - 50px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .mode-toggle {
            display: flex;
            flex-wrap: wrap;
            border-radius: 30px;
            overflow: hidden;
            margin: 0 auto 10px;
            width: auto;
            min-width: 0;
            max-width: 100%;
            border: 2px solid var(--primary-accent);
            box-shadow: 0 2px 16px rgba(0, 255, 204, 0.2);
            position: relative;
            z-index: 10;
            gap: 0;
        }
        
        /* Styles pour les boutons de toggle mode */
        .mode-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: var(--primary-bg);
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            outline: none;
        }
        
        .mode-btn.active {
            background: var(--primary-accent);
            color: var(--text-dark);
            font-weight: 600;
        }
        
        .mode-btn:hover:not(.active) {
            background: rgba(0, 255, 204, 0.1);
        }
        
        /* Styles pour les boutons principaux et secondaires */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 14px;
            border-radius: 6px;
            border: none;
            font-family: inherit;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* Ajout d'un style pour les boutons dans le groupe principal */
        .button-group button {
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }
        
        button svg {
            width: 16px;
            height: 16px;
        }
        
        button.primary {
            background: var(--gradient-1);
            color: var(--text-dark);
            box-shadow: 0 2px 10px rgba(0, 255, 204, 0.25);
        }
        
        button.secondary {
            background: var(--gradient-2);
            color: var(--text-light);
            box-shadow: 0 2px 10px rgba(66, 103, 178, 0.25);
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff4d4d 0%, #d9244c 100%);
            color: var(--text-light);
            box-shadow: 0 2px 10px rgba(255, 77, 77, 0.25);
        }
        
        button.primary:hover, button.secondary:hover, button.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
        }
        
        button.primary:active, button.secondary:active, button.danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        /* Styles pour la galerie */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
        }
        
        .gallery-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
        }
        
        .color-info {
            display: flex;
            align-items: center;
            padding: 5px;
            background: rgba(0, 0, 0, 0.7);
            font-size: 0.65rem;
        }
        
        .color-swatch {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        /* Style pour le message de statut */
        .status-message {
            text-align: center;
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            margin: 10px auto;
            font-size: 0.7rem;
            color: var(--primary-accent);
            max-width: 90%;
        }
        
        .hidden {
            display: none !important;
        }
        
        .target-color-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .color-display {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .color-target {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF0000, #00FF00);
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            margin-bottom: 0;
            border: none; /* Suppression du contour blanc */
            animation: pulse 2s infinite alternate; /* Animation de pulsation */
        }
        
        .color-components {
            display: flex;
            flex-direction: column;
            margin-left: 15px;
        }
        
        .color-component {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 5px 0;
            border: none; /* Suppression du contour blanc */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            animation: rotate 3s infinite alternate; /* Animation de rotation */
        }
        
        /* Ajout des animations */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
            }
        }
        
        @keyframes rotate {
            0% {
                transform: translateY(0) scale(1);
            }
            100% {
                transform: translateY(-5px) scale(1.1);
            }
        }
        
        /* Styles pour l'interface de capture des deux couleurs */
        .capture-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
        }
        
        .capture-slot {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed var(--primary-accent);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.2);
            animation: breathe 3s infinite alternate; /* Animation de "respiration" */
        }
        
        .capture-slot.filled {
            border: none; /* Suppression du contour lorsque rempli */
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.4);
            animation: pulse 2s infinite alternate; /* Animation différente lorsque rempli */
        }
        
        /* Ajout d'une animation de "respiration" */
        @keyframes breathe {
            0% {
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 255, 204, 0.2);
            }
            100% {
                transform: scale(1.05);
                box-shadow: 0 0 10px rgba(0, 255, 204, 0.4);
            }
        }
        
        .color-sample {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none; /* Suppression du contour blanc */
            margin-bottom: 5px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            animation: pulse 2s infinite alternate; /* Animation de pulsation */
        }
        
        #videoContainerChallenge {
            position: relative;
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            background-color: #131c50;
            aspect-ratio: 4/3;
            margin: 0 auto 8px;
            border: 2px solid rgba(0, 255, 204, 0.2);
        }
        
        #videoChallenge, #canvasChallenge {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        #videoPlaceholderChallenge {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: var(--text-light);
            font-size: 0.8rem;
        }
        
        #realtime-color-challenge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px;
            border-radius: 8px;
            z-index: 5;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        #color-preview-challenge {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            border: none; /* Suppression du contour blanc */
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite alternate; /* Animation de pulsation */
        }
        
        #color-value-challenge {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .target-instruction {
            font-size: 0.7rem;
            margin-top: 5px;
            color: var(--text-light);
            opacity: 0.9;
        }
        
        .capture-instructions {
            text-align: center;
            font-size: 0.7rem;
            margin-bottom: 10px;
            color: var(--primary-accent);
            opacity: 0.85;
        }
        
        /* Réduire la taille des textes dans les résultats */
        .challenge-result h3 {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .color-box p {
            font-size: 0.7rem;
            margin-top: 5px;
        }
        
        .score-display p {
            font-size: 0.7rem;
        }
        
        .feedback-message {
            text-align: center;
            margin-top: 10px;
            font-style: italic;
            font-size: 0.7rem;
        }
        
        /* Styles pour le score */
        .score-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 0 15px;
        }
        
        .score-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-accent);
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }
        
        .color-comparison {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .color-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
                width: calc(100% - 10px); /* Optimisation de la largeur */
            }
            
            .mode-toggle {
                width: auto;
                min-width: 0;
                max-width: 100%;
                flex-wrap: wrap;
                margin-bottom: 8px;
                margin-top: 5px; /* Ajout d'une petite marge en haut */
                gap: 0;
            }
            
            /* Réduction de la taille de certains éléments pour mobile */
            .color-target {
                width: 80px;
                height: 80px;
                animation: pulse 2.5s infinite alternate; /* Garder les animations mais ajuster leur intensité */
            }
            
            .color-component {
                width: 30px;
                height: 30px;
                animation: rotate 3.5s infinite alternate; /* Animation moins prononcée sur petits écrans */
            }
            
            .color-sample {
                width: 40px;
                height: 40px;
            }
            
            .capture-slot {
                width: 35px;
                height: 35px;
            }
            
            button {
                padding: 5px 10px;
                font-size: 0.75rem;
            }
            
            /* Réduire davantage la taille des textes sur mobile */
            .target-instruction, 
            .capture-instructions, 
            .status-message, 
            .feedback-message,
            .color-box p,
            .score-display p {
                font-size: 0.65rem;
            }
            
            .challenge-result h3 {
                font-size: 0.8rem;
            }
            
            #videoContainerChallenge {
                max-width: 100%;
                aspect-ratio: 4/3;
                max-height: 50vh;
                margin-bottom: 10px;
            }
            
            /* Optimisations pour les iPhone et autres appareils plus petits */
            @media (max-width: 380px) {
                .container {
                    padding: 6px;
                    max-height: calc(100vh - 50px);
                }
                
                .color-target {
                    width: 70px;
                    height: 70px;
                    animation: pulse 2.5s infinite alternate; /* Garder les animations mais ajuster leur intensité */
                }
                
                .color-component {
                    width: 25px;
                    height: 25px;
                    margin: 4px 0;
                    animation: rotate 3.5s infinite alternate; /* Animation moins prononcée sur petits écrans */
                }
                
                .capture-slot {
                    width: 30px;
                    height: 30px;
                }
                
                .button-group {
                    gap: 5px;
                }
                
                button {
                    padding: 5px 10px;
                    font-size: 0.7rem;
                }
                
                .target-instruction, 
                .capture-instructions, 
                .status-message, 
                .feedback-message,
                .color-box p,
                .score-display p {
                    font-size: 0.6rem;
                }
                
                .challenge-result h3 {
                    font-size: 0.75rem;
                }
                
                #videoContainerChallenge {
                    max-height: 45vh;
                    aspect-ratio: 4/3;
                }
            }
            
            /* Optimisations pour écrans très courts (en hauteur) */
            @media (max-height: 600px) {
                body {
                    padding: 3px 8px;
                }
                
                .container {
                    max-height: calc(100vh - 30px);
                    margin: 0 auto 5px;
                }
                
                .mode-toggle {
                    margin-bottom: 5px;
                }
                
                .color-target {
                    width: 60px;
                    height: 60px;
                }
                
                .color-component {
                    width: 22px;
                    height: 22px;
                    margin: 3px 0;
                }
                
                .capture-slot {
                    width: 25px;
                    height: 25px;
                }
                
                .button-group {
                    margin-top: 6px;
                    gap: 5px;
                }
                
                button {
                    padding: 4px 8px;
                    font-size: 0.65rem;
                }
                
                .capture-instructions, .target-instruction {
                    font-size: 0.65rem;
                    margin-bottom: 5px;
                }
                
                .status-message {
                    padding: 3px 6px;
                    font-size: 0.65rem;
                    margin: 5px auto;
                }
                
                #videoContainerChallenge {
                    max-height: 40vh;
                    margin-bottom: 5px;
                }
                
                .capture-progress {
                    margin-top: 5px;
                    gap: 10px;
                }
            }
            
            /* Optimisations pour les appareils en mode paysage */
            @media (orientation: landscape) and (max-height: 500px) {
                .container {
                    max-height: calc(100vh - 20px);
                }
                
                .color-target {
                    width: 50px;
                    height: 50px;
                }
                
                .color-component {
                    width: 20px;
                    height: 20px;
                    margin: 2px 0;
                }
                
                .target-instruction {
                    margin-top: 2px;
                }
                
                #videoContainerChallenge {
                    max-height: 55vh;
                    aspect-ratio: 16/9;
                    max-width: 70%;
                }
                
                .capture-progress {
                    margin-top: 3px;
                }
                
                .button-group {
                    flex-wrap: nowrap;
                }
            }
        }
    </style>
</head>
<body>
    <div class="mode-toggle">
        <button class="mode-btn active" id="challengeMode">Défi Couleur</button>
        <button class="mode-btn" id="galleryMode">Galerie Photos</button>
        <button class="mode-btn" id="scoreMode">Score</button>
    </div>

    <div class="container" id="challengeModeContainer">
        <div class="target-color-container">
            <div class="color-display">
                <div id="targetColor" class="color-target"></div>
                <div class="color-components">
                    <div id="startColor" class="color-component"></div>
                    <div id="endColor" class="color-component"></div>
                </div>
            </div>
            <p class="target-instruction">Trouvez et photographiez une couleur similaire à celle-ci</p>
        </div>
        
        <div id="videoContainerChallenge">
            <video id="videoChallenge" autoplay playsinline></video>
            <canvas id="canvasChallenge" class="hidden"></canvas>
            <div id="videoPlaceholderChallenge">En attente d'activation de la caméra...</div>
            <div id="focus-grid-challenge"></div>
            <div id="realtime-color-challenge" class="hidden">
                <div id="color-preview-challenge"></div>
                <span id="color-value-challenge">#000000</span>
            </div>
        </div>
        
        <div class="button-group">
            <button id="switchCameraChallenge" class="primary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a6 6 0 0 1 6-6h4.5L10 4.5l.7.7L14.2 2l-3.5-3.2-.7.7L12.5 2H8z"/>
                </svg>
                Changer de caméra
            </button>
            <button id="captureChallengeBtn" class="secondary">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z"/>
                    <path d="M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                </svg>
                Capturer
            </button>
        </div>

        <div class="capture-instructions" id="captureInstructions">
            Capturez d'abord la première couleur, puis la seconde couleur du dégradé
        </div>

        <div class="capture-progress">
            <div id="captureSlot1" class="capture-slot"></div>
            <div id="captureSlot2" class="capture-slot"></div>
        </div>
        
        <div id="challengeResult" class="challenge-result hidden">
            <h3>Résultat</h3>
            <div class="color-comparison">
                <div class="color-box">
                    <div id="targetColorResult" class="color-sample"></div>
                    <p>Couleur cible</p>
                </div>
                <div class="score-display">
                    <div id="scoreValue" class="score-value">0</div>
                    <p>/ 10</p>
                </div>
                <div class="color-box">
                    <div id="capturedColorResult" class="color-sample"></div>
                    <p>Votre couleur</p>
                </div>
            </div>
            <div class="feedback-message" id="feedbackMessage">
                Essayez encore pour mieux correspondre à la couleur cible.
            </div>
            <div style="text-align:center; margin-top:10px;">
                <button id="nextChallengeBtn" class="primary" style="display:none;">
                    Défi suivant
                </button>
            </div>
        </div>
        
        <p id="challengeStatus" class="status-message">Initialisation du défi...</p>
    </div>
    <!-- Ajout du conteneur Score caché -->
    <div class="container hidden" id="scoreModeContainer"></div>

    <script>
        let facingMode = 'user';
        let photos = JSON.parse(localStorage.getItem('capturedPhotos')) || [];
        let challengeScores = JSON.parse(localStorage.getItem('challengeScores')) || [];
        let streamChallenge;
        let challengeColorAnalysisInterval;
        let nextChallengeBtn;
        
        const gradientMap = {
            "#00A993": "#E68B4A", "#E68B4A": "#7A1619", "#7A1619": "#362777",
            "#362777": "#EB7AAE", "#EB7AAE": "#0069AA", "#0069AA": "#DC0C15",
            "#DC0C15": "#E03A8D", "#E03A8D": "#FFFFFF", "#FFFFFF": "#2A4899",
            "#2A4899": "#00A993"
        };
        
        const gradientColors = [
            { start: "#00A993", end: "#E68B4A" },
            { start: "#E68B4A", end: "#7A1619" },
            { start: "#7A1619", end: "#362777" },
            { start: "#362777", end: "#EB7AAE" },
            { start: "#EB7AAE", end: "#0069AA" },
            { start: "#0069AA", end: "#DC0C15" },
            { start: "#DC0C15", end: "#E03A8D" },
            { start: "#E03A8D", end: "#FFFFFF" },
            { start: "#FFFFFF", end: "#2A4899" },
            { start: "#2A4899", end: "#00A993" }
        ];
        
        const challengeMode = document.getElementById('challengeMode');
        const galleryMode = document.getElementById('galleryMode');
        const scoreMode = document.getElementById('scoreMode');
        const challengeModeContainer = document.getElementById('challengeModeContainer');
        const scoreModeContainer = document.getElementById('scoreModeContainer');
        const videoChallenge = document.getElementById('videoChallenge');
        const canvasChallenge = document.getElementById('canvasChallenge');
        const ctxChallenge = canvasChallenge.getContext('2d');
        const targetColor = document.getElementById('targetColor');
        const captureChallengeBtn = document.getElementById('captureChallengeBtn');
        const switchCameraChallenge = document.getElementById('switchCameraChallenge');
        const challengeResult = document.getElementById('challengeResult');
        const targetColorResult = document.getElementById('targetColorResult');
        const capturedColorResult = document.getElementById('capturedColorResult');
        const scoreValue = document.getElementById('scoreValue');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const challengeStatus = document.getElementById('challengeStatus');
        const videoPlaceholderChallenge = document.getElementById('videoPlaceholderChallenge');
        const startColorElement = document.getElementById('startColor');
        const endColorElement = document.getElementById('endColor');
        const captureSlot1 = document.getElementById('captureSlot1');
        const captureSlot2 = document.getElementById('captureSlot2');
        const captureInstructions = document.getElementById('captureInstructions');
        
        let currentTargetColor = { r: 0, g: 0, b: 0 };
        let capturedColors = [null, null];
        let currentCaptureIndex = 0;
        let targetColors = [null, null];
        
        challengeMode.addEventListener('click', () => {
            challengeMode.classList.add('active');
            galleryMode.classList.remove('active');
            scoreMode.classList.remove('active');
            challengeModeContainer.classList.remove('hidden');
            scoreModeContainer.classList.add('hidden');
            
            if (!streamChallenge) {
                initChallengeCamera();
                generateTargetColor();
            }
        });

        galleryMode.addEventListener('click', () => {
            if (streamChallenge) {
                streamChallenge.getTracks().forEach(track => track.stop());
                stopChallengeColorAnalysis();
            }
            
            galleryMode.classList.add('active');
            challengeMode.classList.remove('active');
            scoreMode.classList.remove('active');
            challengeModeContainer.classList.remove('hidden');
            scoreModeContainer.classList.add('hidden');
            
            openGalleryView();
        });

        scoreMode.addEventListener('click', () => {
            if (streamChallenge) {
                streamChallenge.getTracks().forEach(track => track.stop());
                stopChallengeColorAnalysis();
            }
            scoreMode.classList.add('active');
            galleryMode.classList.remove('active');
            challengeMode.classList.remove('active');
            challengeModeContainer.classList.add('hidden');
            scoreModeContainer.classList.remove('hidden');
            openScoreView();
        });
        
        function openGalleryView() {
            const originalChallengeContent = challengeModeContainer.innerHTML;
            
            // Stocker l'élément challengeModeContainer original pour le retour
            const originalContainer = challengeModeContainer;
            
            let galleryContent = `
                <div class="gallery" id="photoGallery">
            `;
            
            if (photos.length === 0) {
                galleryContent += '<p>Aucune photo dans la galerie. Prenez des photos pour les voir ici.</p>';
            } else {
                photos.forEach((photo, index) => {
                    const dominantColor = photo.dominantColor || { rgb: 'rgb(128, 128, 128)', hex: '#808080' };
                    const targetColorDisplay = photo.targetColor ? 
                        `<div class="color-swatch" style="background-color: ${photo.targetColor}"></div>` : '';
                    
                    galleryContent += `
                        <div class="gallery-item">
                            <img class="gallery-img" src="${photo.url}" alt="Photo ${index + 1}">
                            <button class="delete-btn" data-id="${photo.id}">✕</button>
                            <div class="color-info">
                                ${targetColorDisplay}
                                <div class="color-swatch" style="background-color: ${dominantColor.rgb}"></div>
                                <span>${dominantColor.hex}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            galleryContent += `
                </div>
                <div class="button-group">
                    <button id="backToChallengeBtn" class="primary">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 7.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H11.5z"/>
                        </svg>
                        Retour au défi
                    </button>
                    <button id="clearAllBtn" class="danger">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                        </svg>
                        Supprimer toutes les images
                    </button>
                </div>
            `;
            
            challengeModeContainer.innerHTML = galleryContent;
            
            // Réattacher l'écouteur d'événement au bouton "Défi Couleur" pour permettre le retour au défi
            challengeMode.addEventListener('click', function() {
                challengeMode.classList.add('active');
                galleryMode.classList.remove('active');
                
                // Remettre le contenu original
                challengeModeContainer.innerHTML = originalChallengeContent;
                
                // Réinitialiser les références et la caméra
                reinitializeChallengeReferences();
                initChallengeCamera();
                generateTargetColor();
            });
            
            document.getElementById('backToChallengeBtn').addEventListener('click', () => {
                challengeModeContainer.innerHTML = originalChallengeContent;
                reinitializeChallengeReferences();
                challengeMode.classList.add('active');
                galleryMode.classList.remove('active');
                initChallengeCamera();
                generateTargetColor();
            });
            
            document.getElementById('clearAllBtn').addEventListener('click', () => {
                if (confirm('Êtes-vous sûr de vouloir supprimer toutes les photos?')) {
                    photos = [];
                    localStorage.setItem('capturedPhotos', JSON.stringify(photos));
                    document.getElementById('photoGallery').innerHTML = '<p>Aucune photo dans la galerie. Prenez des photos pour les voir ici.</p>';
                }
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const photoId = e.target.dataset.id;
                    deletePhoto(photoId, e.target.closest('.gallery-item'));
                });
            });
        }
        
        function deletePhoto(photoId, element) {
            photos = photos.filter(photo => photo.id !== photoId);
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
            
            if (element) {
                element.remove();
                
                const gallery = document.getElementById('photoGallery');
                if (gallery && gallery.children.length === 0) {
                    gallery.innerHTML = '<p>Aucune photo dans la galerie. Prenez des photos pour les voir ici.</p>';
                }
            }
        }
        
        switchCameraChallenge.addEventListener('click', () => {
            facingMode = facingMode === 'user' ? 'environment' : 'user';
            initChallengeCamera();
        });

        async function initChallengeCamera() {
            try {
                if (streamChallenge) {
                    streamChallenge.getTracks().forEach(track => track.stop());
                    stopChallengeColorAnalysis();
                }
                
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                let constraints;
                
                if (isMobile) {
                    constraints = {
                        audio: false,
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    };
                } else {
                    constraints = {
                        audio: false,
                        video: {
                            facingMode: facingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                }
                
                streamChallenge = await navigator.mediaDevices.getUserMedia(constraints);
                videoChallenge.srcObject = streamChallenge;
                
                videoPlaceholderChallenge.style.display = 'none';
                videoChallenge.style.display = 'block';
                
                videoChallenge.onloadedmetadata = () => {
                    videoChallenge.play().catch(e => console.error('Erreur lors du démarrage de la vidéo challenge:', e));
                    
                    canvasChallenge.width = videoChallenge.videoWidth;
                    canvasChallenge.height = videoChallenge.videoHeight;
                    challengeStatus.textContent = 'Caméra prête. Trouvez une couleur similaire à la cible.';
                    
                    const realtimeColorChallenge = document.getElementById('realtime-color-challenge');
                    realtimeColorChallenge.classList.remove('hidden');
                    
                    setTimeout(() => {
                        startChallengeColorAnalysis();
                    }, 500);
                };
                
                videoChallenge.onplaying = () => {
                    videoChallenge.style.display = 'block';
                    videoPlaceholderChallenge.style.display = 'none';
                    challengeStatus.textContent = 'Défi actif. Trouvez une couleur similaire à la cible.';
                };
            } catch (error) {
                challengeStatus.textContent = `Erreur d'accès à la caméra: ${error.message}`;
                console.error('Erreur d\'accès à la caméra du défi:', error);
                videoPlaceholderChallenge.style.display = 'flex';
                videoPlaceholderChallenge.textContent = `Erreur d'accès à la caméra: ${error.message}`;
            }
        }
        
        function extractDominantColor(imageData, focusOnCenter = false) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const colorCounts = {};
            
            const centerStartX = Math.floor(width * 0.3);
            const centerEndX = Math.floor(width * 0.7);
            const centerStartY = Math.floor(height * 0.3);
            const centerEndY = Math.floor(height * 0.7);
            
            const step = 5;
            
            for (let y = 0; y < height; y += step) {
                for (let x = 0; x < width; x += step) {
                    if (focusOnCenter && (
                        x < centerStartX || x > centerEndX || 
                        y < centerStartY || y > centerEndY
                    )) {
                        continue;
                    }
                    
                    const i = (y * width + x) * 4;
                    
                    if (data[i + 3] < 128 || (data[i] < 30 && data[i + 1] < 30 && data[i + 2] < 30)) {
                        continue;
                    }
                    
                    const r = Math.floor(data[i] / 10) * 10;
                    const g = Math.floor(data[i + 1] / 10) * 10;
                    const b = Math.floor(data[i + 2] / 10) * 10;
                    
                    const colorKey = `${r},${g},${b}`;
                    
                    if (!colorCounts[colorKey]) {
                        colorCounts[colorKey] = 0;
                    }
                    
                    const saturation = Math.max(r, g, b) - Math.min(r, g, b);
                    const weight = 1 + saturation / 255;
                    
                    colorCounts[colorKey] += weight;
                }
            }
            
            let maxCount = 0;
            let dominantColor = '0,0,0';
            
            for (const colorKey in colorCounts) {
                if (colorCounts[colorKey] > maxCount) {
                    maxCount = colorCounts[colorKey];
                    dominantColor = colorKey;
                }
            }
            
            const [r, g, b] = dominantColor.split(',').map(Number);
            return {
                rgb: `rgb(${r}, ${g}, ${b})`,
                hex: `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`
            };
        }
        
        function generateTargetColor() {
            const randomIndex = Math.floor(Math.random() * gradientColors.length);
            const selectedGradient = gradientColors[randomIndex];
            
            const startColor = selectedGradient.start;
            const endColor = selectedGradient.end;
            
            const startRGB = hexToRgb(startColor);
            const endRGB = hexToRgb(endColor);
            
            targetColors = [startRGB, endRGB];
            
            targetColor.style.background = `linear-gradient(135deg, ${startColor}, ${endColor})`;
            
            startColorElement.style.backgroundColor = startColor;
            endColorElement.style.backgroundColor = endColor;
            
            resetCaptureSlots();
            
            challengeResult.classList.add('hidden');
            
            challengeStatus.textContent = 'Nouvelle couleur générée. Capturez d\'abord la couleur de gauche, puis celle de droite.';
            captureInstructions.textContent = 'Capturez d\'abord la couleur de gauche du dégradé';
        }
        
        function hexToRgb(hex) {
            hex = hex.replace(/^#/, '');
            
            const bigint = parseInt(hex, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            
            return { r, g, b };
        }
        
        function calculateColorDistance(color1, color2) {
            if (!color1 || !color2 || 
                typeof color1.r === 'undefined' || typeof color1.g === 'undefined' || typeof color1.b === 'undefined' ||
                typeof color2.r === 'undefined' || typeof color2.g === 'undefined' || typeof color2.b === 'undefined') {
                console.error("Objets de couleur invalides", color1, color2);
                return 442;
            }
            
            return Math.sqrt(
                Math.pow(color1.r - color2.r, 2) +
                Math.pow(color1.g - color2.g, 2) +
                Math.pow(color1.b - color2.b, 2)
            );
        }
        
        function startChallengeColorAnalysis() {
            if (challengeColorAnalysisInterval) {
                clearInterval(challengeColorAnalysisInterval);
            }
            
            const realtimeColorChallenge = document.getElementById('realtime-color-challenge');
            const colorPreviewChallenge = document.getElementById('color-preview-challenge');
            const colorValueChallenge = document.getElementById('color-value-challenge');
            
            realtimeColorChallenge.classList.remove('hidden');
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const interval = isMobile ? 200 : 100;
            
            challengeColorAnalysisInterval = setInterval(() => {
                if (!streamChallenge || videoChallenge.paused || videoChallenge.ended || !videoChallenge.videoWidth) {
                    return;
                }
                
                try {
                    if (tempCanvas.width !== videoChallenge.videoWidth || tempCanvas.height !== videoChallenge.videoHeight) {
                        tempCanvas.width = videoChallenge.videoWidth;
                        tempCanvas.height = videoChallenge.videoHeight;
                    }
                    
                    tempCtx.drawImage(videoChallenge, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const dominantColor = extractDominantColor(imageData, true);
                    
                    colorPreviewChallenge.style.backgroundColor = dominantColor.rgb;
                    colorValueChallenge.textContent = dominantColor.hex;
                } catch (e) {
                    console.error('Erreur dans l\'analyse de couleur du défi:', e);
                }
            }, interval);
        }
        
        function stopChallengeColorAnalysis() {
            if (challengeColorAnalysisInterval) {
                clearInterval(challengeColorAnalysisInterval);
                challengeColorAnalysisInterval = null;
            }
        }
        
        function captureChallengeBtnHandler() {
            canvasChallenge.classList.remove('hidden');
            
            try {
                ctxChallenge.drawImage(videoChallenge, 0, 0, canvasChallenge.width, canvasChallenge.height);
                
                const imageData = ctxChallenge.getImageData(0, 0, canvasChallenge.width, canvasChallenge.height);
                const dominantColor = extractDominantColor(imageData, true);
                
                const rgbMatch = dominantColor.rgb.match(/rgb\((\d+), (\d+), (\d+)\)/);
                if (!rgbMatch) {
                    console.error("Format RGB non valide:", dominantColor.rgb);
                    return;
                }
                
                const capturedR = parseInt(rgbMatch[1]);
                const capturedG = parseInt(rgbMatch[2]);
                const capturedB = parseInt(rgbMatch[3]);
                
                const capturedRGB = { r: capturedR, g: capturedG, b: capturedB };
                
                capturedColors[currentCaptureIndex] = capturedRGB;
                
                const currentSlot = currentCaptureIndex === 0 ? captureSlot1 : captureSlot2;
                currentSlot.style.backgroundColor = dominantColor.rgb;
                currentSlot.classList.add('filled');
                
                const photoDataUrl = canvasChallenge.toDataURL('image/jpeg');
                
                if (currentCaptureIndex === 0) {
                    currentCaptureIndex = 1;
                    
                    const targetColorStr = `rgb(${targetColors[0].r}, ${targetColors[0].g}, ${targetColors[0].b})`;
                    captureInstructions.textContent = "Maintenant, capturez la couleur de droite du dégradé";
                    challengeStatus.textContent = "Première couleur capturée. Cherchez maintenant la seconde.";
                    savePhoto(photoDataUrl, dominantColor, targetColorStr, true);
                    
                    startColorElement.style.opacity = "0.3";
                    endColorElement.style.opacity = "1";
                } else {
                    const targetColorStr = `rgb(${targetColors[1].r}, ${targetColors[1].g}, ${targetColors[1].b})`;
                    savePhoto(photoDataUrl, dominantColor, targetColorStr, false);
                    captureInstructions.textContent = "Les deux couleurs sont capturées!";
                    
                    startColorElement.style.opacity = "1";
                    endColorElement.style.opacity = "1";
                    
                    setTimeout(() => {
                        evaluateColorMatch();
                    }, 100);
                }
                
                canvasChallenge.classList.add('hidden');
                
            } catch (error) {
                console.error("Erreur lors de la capture:", error);
                challengeStatus.textContent = "Erreur lors de la capture. Veuillez réessayer.";
            }
        }

        function evaluateColorMatch() {
            if (!capturedColors[0] || !capturedColors[1]) {
                console.error("Les deux couleurs n'ont pas été capturées correctement");
                challengeStatus.textContent = "Erreur: couleurs incomplètes. Veuillez réessayer.";
                return;
            }
            
            const distance1 = calculateColorDistance(capturedColors[0], targetColors[0]);
            const distance2 = calculateColorDistance(capturedColors[1], targetColors[1]);
            
            const totalDistance = distance1 + distance2;
            let score = 10 - (totalDistance / 441) * 10;
            score = Math.max(0, Math.min(10, score));
            score = Math.round(score * 10) / 10;
            
            if (score > 9.5) score = 10;
            
            displayChallengeResults(score);

            challengeStatus.textContent = "Appuyez sur 'Défi suivant' pour continuer.";
            if (!nextChallengeBtn) {
                nextChallengeBtn = document.getElementById('nextChallengeBtn');
            }
            if (nextChallengeBtn) {
                nextChallengeBtn.style.display = '';
                nextChallengeBtn.disabled = false;
            }
        }

        function savePhoto(dataUrl, dominantColor, targetColorStr, isFirstColor) {
            const timestamp = new Date().toISOString();
            
            photos.push({
                id: Date.now().toString(),
                url: dataUrl,
                timestamp: timestamp,
                dominantColor: dominantColor,
                targetColor: targetColorStr,
                isFirstColor: isFirstColor
            });
            
            localStorage.setItem('capturedPhotos', JSON.stringify(photos));
        }

        function displayChallengeResults(score) {
            challengeResult.classList.remove('hidden');

            // Fallback pour éviter un dégradé cassé sur mobile
            const safeCaptured0 = capturedColors[0] && typeof capturedColors[0].r === 'number'
                ? capturedColors[0]
                : { r: 128, g: 128, b: 128 };
            const safeCaptured1 = capturedColors[1] && typeof capturedColors[1].r === 'number'
                ? capturedColors[1]
                : { r: 128, g: 128, b: 128 };

            const targetGradient = `linear-gradient(135deg, rgb(${targetColors[0].r}, ${targetColors[0].g}, ${targetColors[0].b}), rgb(${targetColors[1].r}, ${targetColors[1].g}, ${targetColors[1].b}))`;
            const capturedGradient = `linear-gradient(135deg, rgb(${safeCaptured0.r}, ${safeCaptured0.g}, ${safeCaptured0.b}), rgb(${safeCaptured1.r}, ${safeCaptured1.g}, ${safeCaptured1.b}))`;

            targetColorResult.style.background = targetGradient;
            capturedColorResult.style.background = capturedGradient;

            scoreValue.textContent = score;

            if (score >= 9) {
                feedbackMessage.textContent = "Excellent! Vous avez trouvé des correspondances parfaites!";
            } else if (score >= 7) {
                feedbackMessage.textContent = "Très bien! Vous avez trouvé des couleurs très proches.";
            } else if (score >= 5) {
                feedbackMessage.textContent = "Bien! Vous vous rapprochez des couleurs cibles.";
            } else {
                feedbackMessage.textContent = "Essayez encore pour mieux correspondre aux couleurs cibles.";
            }

            // Enregistrer le score dans l'historique
            challengeScores.push({
                date: new Date().toISOString(),
                target: [
                    { ...targetColors[0] },
                    { ...targetColors[1] }
                ],
                captured: [
                    capturedColors[0] ? { ...capturedColors[0] } : null,
                    capturedColors[1] ? { ...capturedColors[1] } : null
                ],
                score: score
            });
            localStorage.setItem('challengeScores', JSON.stringify(challengeScores));

            if (!nextChallengeBtn) {
                nextChallengeBtn = document.getElementById('nextChallengeBtn');
            }
            if (nextChallengeBtn) {
                nextChallengeBtn.style.display = '';
                nextChallengeBtn.disabled = false;
            }
        }

        function resetCaptureSlots() {
            capturedColors = [null, null];
            currentCaptureIndex = 0;
            
            captureSlot1.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
            captureSlot2.style.backgroundColor = 'rgba(0, 0, 0, 0.2)';
            
            captureSlot1.classList.remove('filled');
            captureSlot2.classList.remove('filled');
            
            startColorElement.style.opacity = "1";
            endColorElement.style.opacity = "0.3";

            if (!nextChallengeBtn) {
                nextChallengeBtn = document.getElementById('nextChallengeBtn');
            }
            if (nextChallengeBtn) {
                nextChallengeBtn.style.display = 'none';
                nextChallengeBtn.disabled = true;
            }
        }
        
        function handleOrientationChange() {
            if (videoChallenge.videoWidth && videoChallenge.videoHeight) {
                canvasChallenge.width = videoChallenge.videoWidth;
                canvasChallenge.height = videoChallenge.videoHeight;
            }
            
            const galleryContainer = document.getElementById('galleryModeContainer');
            if (!galleryContainer.classList.contains('hidden')) {
                loadGallery();
            }
        }
        
        window.addEventListener('orientationchange', function() {
            setTimeout(handleOrientationChange, 300);
        });
        
        window.addEventListener('beforeunload', () => {
            stopChallengeColorAnalysis();
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                challengeStatus.textContent = 'Votre navigateur ne prend pas en charge l\'accès à la caméra.';
                videoPlaceholderChallenge.textContent = 'Votre navigateur ne prend pas en charge l\'accès à la caméra.';
            } else {
                initChallengeCamera();
                generateTargetColor();
                
                captureChallengeBtn.addEventListener('click', captureChallengeBtnHandler);
                
                setTimeout(() => {
                    if (videoChallenge && !videoChallenge.videoWidth) {
                        console.log('Tentative de réinitialisation de la caméra...');
                        initChallengeCamera();
                    }
                }, 3000);
            }

            const reattachMainButtonListeners = () => {
                challengeMode.addEventListener('click', () => {
                    challengeMode.classList.add('active');
                    galleryMode.classList.remove('active');
                    scoreMode.classList.remove('active');
                    challengeModeContainer.classList.remove('hidden');
                    scoreModeContainer.classList.add('hidden');
                    
                    if (!streamChallenge) {
                        initChallengeCamera();
                        generateTargetColor();
                    }
                });
            };
            
            reattachMainButtonListeners();

            nextChallengeBtn = document.getElementById('nextChallengeBtn');
            if (nextChallengeBtn) {
                nextChallengeBtn.addEventListener('click', function() {
                    nextChallengeBtn.style.display = 'none';
                    nextChallengeBtn.disabled = true;
                    generateTargetColor();
                });
            }
        });
        
        function reinitializeChallengeReferences() {
            const videoChallenge = document.getElementById('videoChallenge');
            const canvasChallenge = document.getElementById('canvasChallenge');
            const ctxChallenge = canvasChallenge.getContext('2d');
            const targetColor = document.getElementById('targetColor');
            const captureChallengeBtn = document.getElementById('captureChallengeBtn');
            const switchCameraChallenge = document.getElementById('switchCameraChallenge');
            const challengeResult = document.getElementById('challengeResult');
            const targetColorResult = document.getElementById('targetColorResult');
            const capturedColorResult = document.getElementById('capturedColorResult');
            const scoreValue = document.getElementById('scoreValue');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const challengeStatus = document.getElementById('challengeStatus');
            const videoPlaceholderChallenge = document.getElementById('videoPlaceholderChallenge');
            const startColorElement = document.getElementById('startColor');
            const endColorElement = document.getElementById('endColor');
            const captureSlot1 = document.getElementById('captureSlot1');
            const captureSlot2 = document.getElementById('captureSlot2');
            const captureInstructions = document.getElementById('captureInstructions');
            const nextChallengeBtnRef = document.getElementById('nextChallengeBtn');
            
            if (captureChallengeBtn) {
                captureChallengeBtn.addEventListener('click', captureChallengeBtnHandler);
            }
            
            if (switchCameraChallenge) {
                switchCameraChallenge.addEventListener('click', () => {
                    facingMode = facingMode === 'user' ? 'environment' : 'user';
                    initChallengeCamera();
                });
            }

            if (nextChallengeBtnRef) {
                nextChallengeBtnRef.addEventListener('click', function() {
                    nextChallengeBtnRef.style.display = 'none';
                    nextChallengeBtnRef.disabled = true;
                    generateTargetColor();
                });
            }
        }

        function openScoreView() {
            let html = `
                <h3 style="text-align:center;margin-bottom:10px;">Historique des scores</h3>
                <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="padding:6px 2px;font-size:0.8em;">Dégradé attendu</th>
                            <th style="padding:6px 2px;font-size:0.8em;">Dégradé pris</th>
                            <th style="padding:6px 2px;font-size:0.8em;">Score</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            if (!challengeScores.length) {
                html += `<tr><td colspan="3" style="text-align:center;padding:12px;">Aucun score enregistré pour l'instant.</td></tr>`;
            } else {
                challengeScores.slice().reverse().forEach(entry => {
                    // Fallback couleurs
                    const t0 = entry.target[0] || { r:128,g:128,b:128 };
                    const t1 = entry.target[1] || { r:128,g:128,b:128 };
                    const c0 = entry.captured[0] || { r:128,g:128,b:128 };
                    const c1 = entry.captured[1] || { r:128,g:128,b:128 };
                    html += `
                        <tr>
                            <td style="padding:4px;">
                                <div style="width:60px;height:24px;border-radius:8px;background:linear-gradient(135deg, rgb(${t0.r},${t0.g},${t0.b}), rgb(${t1.r},${t1.g},${t1.b}));border:1px solid #222;"></div>
                            </td>
                            <td style="padding:4px;">
                                <div style="width:60px;height:24px;border-radius:8px;background:linear-gradient(135deg, rgb(${c0.r},${c0.g},${c0.b}), rgb(${c1.r},${c1.g},${c1.b}));border:1px solid #222;"></div>
                            </td>
                            <td style="padding:4px;text-align:center;font-weight:bold;color:#00ffcc;text-shadow:0 0 2px #111;">${entry.score}</td>
                        </tr>
                    `;
                });
            }
            html += `
                    </tbody>
                </table>
                </div>
                <div class="button-group" style="margin-top:16px;">
                    <button id="backToChallengeFromScore" class="primary">
                        Retour au défi
                    </button>
                    <button id="clearScoresBtn" class="danger">
                        Effacer les scores
                    </button>
                </div>
            `;
            scoreModeContainer.innerHTML = html;

            document.getElementById('backToChallengeFromScore').onclick = () => {
                scoreMode.classList.remove('active');
                challengeMode.classList.add('active');
                scoreModeContainer.classList.add('hidden');
                challengeModeContainer.classList.remove('hidden');
                if (!streamChallenge) {
                    initChallengeCamera();
                    generateTargetColor();
                }
            };
            document.getElementById('clearScoresBtn').onclick = () => {
                if (confirm('Effacer tout l\'historique des scores ?')) {
                    challengeScores = [];
                    localStorage.setItem('challengeScores', JSON.stringify(challengeScores));
                    openScoreView();
                }
            };
        }
    </script>
</body>
</html>